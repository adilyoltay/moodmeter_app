{"version":3,"names":["_getJestObj","mock","supabase","mockClient","_interopRequireDefault","require","_asyncToGenerator2","_require2","jest","callLog","qb","table","state","filters","api","select","fn","_len","arguments","length","args","Array","_key","push","op","upsert","_len2","_key2","insert","_len3","_key3","update","_len4","_key4","delete","_len5","_key5","eq","field","value","maybeSingle","default","data","error","single","ok","mockAuth","getUser","user","id","email","user_metadata","name","app_metadata","provider","updateUser","from","auth","getSvc","mod","console","log","Object","keys","createSupabaseServiceForTest","beforeEach","clearAllMocks","describe","test","qbUsers","mockImplementation","mockResolvedValueOnce","svc","res","createGamificationProfile","usersUpsert","find","l","expect","toBeTruthy","upsertBody","toMatchObject","gpUpsert","toBe","userId","payload","profile","age","gender","locale","timezone","motivation","first_mood","score","tags","lifestyle","sleep_hours","exercise","social","reminders","enabled","time","days","feature_flags","a","b","consent","accepted","_require","mapOnboardingPayloadToUserProfileRow","body","user_id","motivations","toEqual","first_mood_score","first_mood_tags","reminder_enabled","reminder_time","onboarding_version","onboarding_completed_at"],"sources":["auth_onboarding_supabase.test.ts"],"sourcesContent":["// Lightweight Supabase client mock wired via module alias\ntype AnyFn = (...args: any[]) => any;\n\nconst callLog: any[] = [];\n\n// Chainable query builder mock\nfunction qb(table: string) {\n  const state: any = { table, filters: [] };\n  const api: any = {\n    select: jest.fn((...args: any[]) => { callLog.push({ op: 'select', table, args }); return api; }),\n    upsert: jest.fn((...args: any[]) => { callLog.push({ op: 'upsert', table, args }); return api; }),\n    insert: jest.fn((...args: any[]) => { callLog.push({ op: 'insert', table, args }); return api; }),\n    update: jest.fn((...args: any[]) => { callLog.push({ op: 'update', table, args }); return api; }),\n    delete: jest.fn((...args: any[]) => { callLog.push({ op: 'delete', table, args }); return api; }),\n    eq: jest.fn((field: string, value: any) => { state.filters.push({ field, value }); return api; }),\n    maybeSingle: jest.fn(async () => ({ data: null, error: null })),\n    single: jest.fn(async () => ({ data: { ok: true }, error: null })),\n  };\n  return api;\n}\n\nconst mockAuth = {\n  getUser: jest.fn(async () => ({\n    user: {\n      id: 'user-1',\n      email: 'new@user.test',\n      user_metadata: { name: 'New User' },\n      app_metadata: { provider: 'email' }\n    }\n  })),\n  updateUser: jest.fn(async () => ({ data: {}, error: null })),\n};\n\nconst mockClient = {\n  from: jest.fn((table: string) => qb(table)),\n  auth: mockAuth,\n};\n\njest.mock('@/lib/supabase', () => ({\n  supabase: mockClient,\n}));\n\n// Defer importing the service until after mocks are set up\nconst getSvc = () => {\n  const mod = require('../../services/supabase');\n  // Debug available exports if needed\n  // eslint-disable-next-line no-console\n  console.log('services/supabase exports:', Object.keys(mod));\n  const { createSupabaseServiceForTest } = mod;\n  // Inject our mock Supabase client to the service\n  return createSupabaseServiceForTest(mockClient as any);\n};\n\nbeforeEach(() => {\n  callLog.length = 0;\n  jest.clearAllMocks();\n});\n\ndescribe('Signup + Onboarding Supabase writes', () => {\n  test('createGamificationProfile ensures users row upsert when missing', async () => {\n    // Arrange: make users select().eq().single() return no row\n    const qbUsers = qb('users');\n    (mockClient.from as AnyFn).mockImplementation((table: string) => {\n      if (table === 'users') {\n        // override single() for first select to simulate missing user\n        qbUsers.single.mockResolvedValueOnce({ data: null, error: null });\n        // for upsert().select().single() after ensureUserProfileExists\n        return qbUsers;\n      }\n      return qb(table);\n    });\n\n    // Act\n    const svc = getSvc();\n    const res = await svc.createGamificationProfile('user-1');\n\n    // Assert: users upsert called with id/email/name/provider\n    const usersUpsert = callLog.find(l => l.op === 'upsert' && l.table === 'users');\n    expect(usersUpsert).toBeTruthy();\n    const upsertBody = usersUpsert.args[0];\n    expect(upsertBody).toMatchObject({ id: 'user-1', email: 'new@user.test', provider: 'email' });\n\n    // And gamification_profiles upsert executed\n    const gpUpsert = callLog.find(l => l.op === 'upsert' && l.table === 'gamification_profiles');\n    expect(gpUpsert).toBeTruthy();\n    expect(res === null || typeof res === 'object').toBe(true);\n  });\n\n  test('upsertUserProfile maps onboarding payload correctly into user_profiles', async () => {\n    const userId = 'user-2';\n    const payload = {\n      profile: { age: 27, gender: 'male', locale: 'tr-TR', timezone: 'Europe/Istanbul' },\n      motivation: ['stress_reduction', 'mental_clarity'],\n      first_mood: { score: 6, tags: ['work', 'sleep'] }, // score should clamp to 5\n      lifestyle: { sleep_hours: 5, exercise: 'Regular', social: 'High' },\n      reminders: { enabled: true, time: '21:30', days: ['Mon','Wed'], timezone: 'Europe/Istanbul' },\n      feature_flags: { a: true, b: false },\n      consent: { accepted: true },\n    };\n\n    // fresh mock per test\n    (mockClient.from as AnyFn).mockImplementation((table: string) => qb(table));\n\n    // Instead of calling service (resolver differences), test exported mapper\n    const { mapOnboardingPayloadToUserProfileRow } = require('../../utils/onboardingMapper');\n    const body = mapOnboardingPayloadToUserProfileRow(userId, payload);\n\n    // Key field expectations\n    expect(body.user_id).toBe(userId);\n    expect(body.motivations).toEqual(['stress_reduction', 'mental_clarity']);\n    expect(body.first_mood_score).toBe(5); // clamped\n    expect(body.first_mood_tags).toEqual(['work','sleep']);\n    expect(body.reminder_enabled).toBe(true);\n    expect(body.reminder_time).toBe('21:30');\n    expect(body.feature_flags).toEqual({ a: true, b: false });\n    expect(body.onboarding_version).toBe(2);\n    expect(typeof body.onboarding_completed_at).toBe('string');\n  });\n});\n"],"mappings":"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","ignoreList":[]}