3c8d2395f588f180b851499d8ed63c4c
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));
var _UnifiedAIPipeline = require("../../features/ai/core/UnifiedAIPipeline");
var _supabaseTestClient = require("./utils/supabaseTestClient");
var userId = process.env.TEST_SEED_USER_ID || 'test-user-live-1';
var supabase = (0, _supabaseTestClient.createSupabaseTestClient)();
function cleanup() {
  return _cleanup.apply(this, arguments);
}
function _cleanup() {
  _cleanup = (0, _asyncToGenerator2.default)(function* () {
    yield supabase.from('ai_cache').delete().ilike('cache_key', `unified:${userId}:%`).eq('user_id', userId);
    yield supabase.from('ai_telemetry').delete().eq('user_id', userId);
  });
  return _cleanup.apply(this, arguments);
}
describe('Live Today Supabase', function () {
  beforeAll((0, _asyncToGenerator2.default)(function* () {
    process.env.TEST_MODE = '1';
    process.env.TEST_TTL_MS = '5000';
    process.env.TEST_PIPELINE_STUB = '0';
    process.env.EXPO_PUBLIC_ENABLE_AI = 'true';
    yield cleanup();
  }));
  afterAll((0, _asyncToGenerator2.default)(function* () {
    yield cleanup();
  }));
  it('[QRlive:today:fresh] writes ai_cache on fresh run', (0, _asyncToGenerator2.default)(function* () {
    var moods = Array.from({
      length: 10
    }, function (_, i) {
      return {
        timestamp: Date.now() - i * 3600e3,
        mood_score: 7
      };
    });
    yield _UnifiedAIPipeline.unifiedPipeline.process({
      userId: userId,
      type: 'data',
      content: {
        moods: moods
      },
      context: {
        source: 'mood'
      }
    });
    var _yield$supabase$from$ = yield supabase.from('ai_cache').select('cache_key, content, expires_at').eq('user_id', userId).ilike('cache_key', `unified:${userId}:%`).limit(1),
      data = _yield$supabase$from$.data,
      error = _yield$supabase$from$.error;
    expect(error).toBeNull();
    expect((data || []).length).toBeGreaterThan(0);
  }));
  it('[QRlive:today:cache] reads from cache on second run', (0, _asyncToGenerator2.default)(function* () {
    var moods = Array.from({
      length: 8
    }, function (_, i) {
      return {
        timestamp: Date.now() - i * 1800e3,
        mood_score: 6.5
      };
    });
    yield _UnifiedAIPipeline.unifiedPipeline.process({
      userId: userId,
      type: 'data',
      content: {
        moods: moods
      },
      context: {
        source: 'mood'
      }
    });
    var second = yield _UnifiedAIPipeline.unifiedPipeline.process({
      userId: userId,
      type: 'data',
      content: {
        moods: moods
      },
      context: {
        source: 'mood'
      }
    });
    expect(second.metadata.source).toBe('cache');
  }));
  it('[QRlive:today:invalidate] deletes ai_cache rows on invalidation', (0, _asyncToGenerator2.default)(function* () {
    yield _UnifiedAIPipeline.unifiedPipeline.triggerInvalidation('mood_added', userId);
    var _yield$supabase$from$2 = yield supabase.from('ai_cache').select('cache_key').eq('user_id', userId).ilike('cache_key', `unified:${userId}:%`),
      data = _yield$supabase$from$2.data,
      error = _yield$supabase$from$2.error;
    expect(error).toBeNull();
    expect((data || []).length).toBe(0);
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfVW5pZmllZEFJUGlwZWxpbmUiLCJyZXF1aXJlIiwiX3N1cGFiYXNlVGVzdENsaWVudCIsInVzZXJJZCIsInByb2Nlc3MiLCJlbnYiLCJURVNUX1NFRURfVVNFUl9JRCIsInN1cGFiYXNlIiwiY3JlYXRlU3VwYWJhc2VUZXN0Q2xpZW50IiwiY2xlYW51cCIsIl9jbGVhbnVwIiwiYXBwbHkiLCJhcmd1bWVudHMiLCJfYXN5bmNUb0dlbmVyYXRvcjIiLCJkZWZhdWx0IiwiZnJvbSIsImRlbGV0ZSIsImlsaWtlIiwiZXEiLCJkZXNjcmliZSIsImJlZm9yZUFsbCIsIlRFU1RfTU9ERSIsIlRFU1RfVFRMX01TIiwiVEVTVF9QSVBFTElORV9TVFVCIiwiRVhQT19QVUJMSUNfRU5BQkxFX0FJIiwiYWZ0ZXJBbGwiLCJpdCIsIm1vb2RzIiwiQXJyYXkiLCJsZW5ndGgiLCJfIiwiaSIsInRpbWVzdGFtcCIsIkRhdGUiLCJub3ciLCJtb29kX3Njb3JlIiwidW5pZmllZFBpcGVsaW5lIiwidHlwZSIsImNvbnRlbnQiLCJjb250ZXh0Iiwic291cmNlIiwiX3lpZWxkJHN1cGFiYXNlJGZyb20kIiwic2VsZWN0IiwibGltaXQiLCJkYXRhIiwiZXJyb3IiLCJleHBlY3QiLCJ0b0JlTnVsbCIsInRvQmVHcmVhdGVyVGhhbiIsInNlY29uZCIsIm1ldGFkYXRhIiwidG9CZSIsInRyaWdnZXJJbnZhbGlkYXRpb24iLCJfeWllbGQkc3VwYWJhc2UkZnJvbSQyIl0sInNvdXJjZXMiOlsiTGl2ZVRvZGF5U3VwYWJhc2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIExpdmUgU3VwYWJhc2UgVGVzdHMg4oCUIFRvZGF5IChRUmxpdmUpXG4gKiBUYWdzOiBbUVJsaXZlOnRvZGF5OmZyZXNofGNhY2hlfGludmFsaWRhdGVdXG4gKi9cbmltcG9ydCB7IHVuaWZpZWRQaXBlbGluZSB9IGZyb20gJ0AvZmVhdHVyZXMvYWkvY29yZS9VbmlmaWVkQUlQaXBlbGluZSc7XG5pbXBvcnQgeyBjcmVhdGVTdXBhYmFzZVRlc3RDbGllbnQgfSBmcm9tICcuL3V0aWxzL3N1cGFiYXNlVGVzdENsaWVudCc7XG5cbmNvbnN0IHVzZXJJZCA9IHByb2Nlc3MuZW52LlRFU1RfU0VFRF9VU0VSX0lEIHx8ICd0ZXN0LXVzZXItbGl2ZS0xJztcbmNvbnN0IHN1cGFiYXNlID0gY3JlYXRlU3VwYWJhc2VUZXN0Q2xpZW50KCk7XG5cbmFzeW5jIGZ1bmN0aW9uIGNsZWFudXAoKSB7XG4gIGF3YWl0IHN1cGFiYXNlLmZyb20oJ2FpX2NhY2hlJykuZGVsZXRlKCkuaWxpa2UoJ2NhY2hlX2tleScsIGB1bmlmaWVkOiR7dXNlcklkfTolYCkuZXEoJ3VzZXJfaWQnLCB1c2VySWQpO1xuICBhd2FpdCBzdXBhYmFzZS5mcm9tKCdhaV90ZWxlbWV0cnknKS5kZWxldGUoKS5lcSgndXNlcl9pZCcsIHVzZXJJZCk7XG59XG5cbmRlc2NyaWJlKCdMaXZlIFRvZGF5IFN1cGFiYXNlJywgKCkgPT4ge1xuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIHByb2Nlc3MuZW52LlRFU1RfTU9ERSA9ICcxJztcbiAgICBwcm9jZXNzLmVudi5URVNUX1RUTF9NUyA9ICc1MDAwJztcbiAgICBwcm9jZXNzLmVudi5URVNUX1BJUEVMSU5FX1NUVUIgPSAnMCc7XG4gICAgcHJvY2Vzcy5lbnYuRVhQT19QVUJMSUNfRU5BQkxFX0FJID0gJ3RydWUnO1xuICAgIGF3YWl0IGNsZWFudXAoKTtcbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGNsZWFudXAoKTtcbiAgfSk7XG5cbiAgaXQoJ1tRUmxpdmU6dG9kYXk6ZnJlc2hdIHdyaXRlcyBhaV9jYWNoZSBvbiBmcmVzaCBydW4nLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9vZHMgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiAxMCB9LCAoXywgaSkgPT4gKHsgdGltZXN0YW1wOiBEYXRlLm5vdygpIC0gaSAqIDM2MDBlMywgbW9vZF9zY29yZTogNyB9KSk7XG4gICAgYXdhaXQgdW5pZmllZFBpcGVsaW5lLnByb2Nlc3MoeyB1c2VySWQsIHR5cGU6ICdkYXRhJywgY29udGVudDogeyBtb29kcyB9LCBjb250ZXh0OiB7IHNvdXJjZTogJ21vb2QnIH0gfSk7XG5cbiAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oJ2FpX2NhY2hlJylcbiAgICAgIC5zZWxlY3QoJ2NhY2hlX2tleSwgY29udGVudCwgZXhwaXJlc19hdCcpXG4gICAgICAuZXEoJ3VzZXJfaWQnLCB1c2VySWQpXG4gICAgICAuaWxpa2UoJ2NhY2hlX2tleScsIGB1bmlmaWVkOiR7dXNlcklkfTolYClcbiAgICAgIC5saW1pdCgxKTtcbiAgICBleHBlY3QoZXJyb3IpLnRvQmVOdWxsKCk7XG4gICAgZXhwZWN0KChkYXRhIHx8IFtdKS5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgfSk7XG5cbiAgaXQoJ1tRUmxpdmU6dG9kYXk6Y2FjaGVdIHJlYWRzIGZyb20gY2FjaGUgb24gc2Vjb25kIHJ1bicsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb29kcyA9IEFycmF5LmZyb20oeyBsZW5ndGg6IDggfSwgKF8sIGkpID0+ICh7IHRpbWVzdGFtcDogRGF0ZS5ub3coKSAtIGkgKiAxODAwZTMsIG1vb2Rfc2NvcmU6IDYuNSB9KSk7XG4gICAgYXdhaXQgdW5pZmllZFBpcGVsaW5lLnByb2Nlc3MoeyB1c2VySWQsIHR5cGU6ICdkYXRhJywgY29udGVudDogeyBtb29kcyB9LCBjb250ZXh0OiB7IHNvdXJjZTogJ21vb2QnIH0gfSk7XG4gICAgY29uc3Qgc2Vjb25kID0gYXdhaXQgdW5pZmllZFBpcGVsaW5lLnByb2Nlc3MoeyB1c2VySWQsIHR5cGU6ICdkYXRhJywgY29udGVudDogeyBtb29kcyB9LCBjb250ZXh0OiB7IHNvdXJjZTogJ21vb2QnIH0gfSk7XG4gICAgZXhwZWN0KHNlY29uZC5tZXRhZGF0YS5zb3VyY2UpLnRvQmUoJ2NhY2hlJyk7XG4gIH0pO1xuXG4gIGl0KCdbUVJsaXZlOnRvZGF5OmludmFsaWRhdGVdIGRlbGV0ZXMgYWlfY2FjaGUgcm93cyBvbiBpbnZhbGlkYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgdW5pZmllZFBpcGVsaW5lLnRyaWdnZXJJbnZhbGlkYXRpb24oJ21vb2RfYWRkZWQnLCB1c2VySWQpO1xuICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAuZnJvbSgnYWlfY2FjaGUnKVxuICAgICAgLnNlbGVjdCgnY2FjaGVfa2V5JylcbiAgICAgIC5lcSgndXNlcl9pZCcsIHVzZXJJZClcbiAgICAgIC5pbGlrZSgnY2FjaGVfa2V5JywgYHVuaWZpZWQ6JHt1c2VySWR9OiVgKTtcbiAgICBleHBlY3QoZXJyb3IpLnRvQmVOdWxsKCk7XG4gICAgZXhwZWN0KChkYXRhIHx8IFtdKS5sZW5ndGgpLnRvQmUoMCk7XG4gIH0pO1xufSk7XG5cblxuIl0sIm1hcHBpbmdzIjoiOztBQUlBLElBQUFBLGtCQUFBLEdBQUFDLE9BQUE7QUFDQSxJQUFBQyxtQkFBQSxHQUFBRCxPQUFBO0FBRUEsSUFBTUUsTUFBTSxHQUFHQyxPQUFPLENBQUNDLEdBQUcsQ0FBQ0MsaUJBQWlCLElBQUksa0JBQWtCO0FBQ2xFLElBQU1DLFFBQVEsR0FBRyxJQUFBQyw0Q0FBd0IsRUFBQyxDQUFDO0FBQUMsU0FFN0JDLE9BQU9BLENBQUE7RUFBQSxPQUFBQyxRQUFBLENBQUFDLEtBQUEsT0FBQUMsU0FBQTtBQUFBO0FBQUEsU0FBQUYsU0FBQTtFQUFBQSxRQUFBLE9BQUFHLGtCQUFBLENBQUFDLE9BQUEsRUFBdEIsYUFBeUI7SUFDdkIsTUFBTVAsUUFBUSxDQUFDUSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUNDLE1BQU0sQ0FBQyxDQUFDLENBQUNDLEtBQUssQ0FBQyxXQUFXLEVBQUUsV0FBV2QsTUFBTSxJQUFJLENBQUMsQ0FBQ2UsRUFBRSxDQUFDLFNBQVMsRUFBRWYsTUFBTSxDQUFDO0lB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