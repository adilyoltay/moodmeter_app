{"version":3,"names":["_getJestObj","mock","_require","require","createSupabaseTestClient","client","__esModule","default","supabaseClient","_interopRequireDefault","_asyncToGenerator2","_require4","jest","_require2","unifiedPipeline","_require3","userId","process","env","TEST_SEED_USER_ID","supabase","cleanup","_cleanup","apply","arguments","from","delete","ilike","eq","describe","beforeAll","TEST_MODE","TEST_TTL_MS","TEST_PIPELINE_STUB","EXPO_PUBLIC_ENABLE_AI","afterAll","it","moods","Array","length","_","i","timestamp","Date","now","mood_score","type","content","context","source","data","error","res","select","limit","Promise","r","setTimeout","expect","toBeNull","toBeGreaterThan","second","metadata","toBe","triggerInvalidation","rows","err"],"sources":["LiveTodaySupabase.spec.ts"],"sourcesContent":["/**\n * Live Supabase Tests â€” Today (QRlive)\n * Tags: [QRlive:today:fresh|cache|invalidate]\n */\n// Replace app supabase service with service-role client for live tests\njest.mock('@/services/supabase', () => {\n  const { createSupabaseTestClient } = require('./utils/supabaseTestClient');\n  const client = createSupabaseTestClient();\n  return {\n    __esModule: true,\n    default: { supabaseClient: client },\n    supabaseClient: client,\n  };\n});\n\nconst { unifiedPipeline } = require('@/features/ai/core/UnifiedAIPipeline');\nconst { createSupabaseTestClient } = require('./utils/supabaseTestClient');\n\nconst userId = process.env.TEST_SEED_USER_ID || '00000000-0000-0000-0000-000000000001';\nconst supabase = createSupabaseTestClient();\n\nasync function cleanup() {\n  await supabase.from('ai_cache').delete().ilike('cache_key', `unified:${userId}:%`);\n  await supabase.from('ai_telemetry').delete().eq('user_id', userId);\n}\n\ndescribe('Live Today Supabase', () => {\n  beforeAll(async () => {\n    process.env.TEST_MODE = '1';\n    process.env.TEST_TTL_MS = '5000';\n    process.env.TEST_PIPELINE_STUB = '0';\n    process.env.EXPO_PUBLIC_ENABLE_AI = 'true';\n    process.env.TEST_SEED_USER_ID = userId;\n    await cleanup();\n  });\n\n  afterAll(async () => {\n    await cleanup();\n  });\n\n  it('[QRlive:today:fresh] writes ai_cache on fresh run', async () => {\n    const moods = Array.from({ length: 10 }, (_, i) => ({ timestamp: Date.now() - i * 3600e3, mood_score: 7 }));\n    await unifiedPipeline.process({ userId, type: 'data', content: { moods }, context: { source: 'mood' } });\n    // Poll briefly to allow DB upsert\n    let data: any[] | null = null;\n    let error: any = null;\n    for (let i = 0; i < 10; i++) {\n      const res = await supabase\n        .from('ai_cache')\n        .select('cache_key, content, expires_at')\n        .ilike('cache_key', `unified:${userId}:%`)\n        .limit(1);\n      data = (res as any).data as any[] | null;\n      error = (res as any).error;\n      if (!error && (data || []).length > 0) break;\n      await new Promise(r => setTimeout(r, 100));\n    }\n    expect(error).toBeNull();\n    expect((data || []).length).toBeGreaterThan(0);\n  });\n\n  it('[QRlive:today:cache] reads from cache on second run', async () => {\n    const moods = Array.from({ length: 8 }, (_, i) => ({ timestamp: Date.now() - i * 1800e3, mood_score: 6.5 }));\n    await unifiedPipeline.process({ userId, type: 'data', content: { moods }, context: { source: 'mood' } });\n    const second = await unifiedPipeline.process({ userId, type: 'data', content: { moods }, context: { source: 'mood' } });\n    expect(second.metadata.source).toBe('cache');\n  });\n\n  it('[QRlive:today:invalidate] deletes ai_cache rows on invalidation', async () => {\n    await unifiedPipeline.triggerInvalidation('mood_added', userId);\n    // Poll for deletion\n    let rows: any[] | null = null;\n    let err: any = null;\n    for (let i = 0; i < 10; i++) {\n      const res = await supabase\n        .from('ai_cache')\n        .select('cache_key')\n        .ilike('cache_key', `unified:${userId}:%`);\n      rows = (res as any).data as any[] | null;\n      err = (res as any).error;\n      if (!err && (rows || []).length === 0) break;\n      await new Promise(r => setTimeout(r, 100));\n    }\n    expect(err).toBeNull();\n    expect((rows || []).length).toBe(0);\n  });\n});\n\n\n"],"mappings":"AAKAA,WAAA,GAAKC,IAAI,4BAAwB,YAAM;EACrC,IAAAC,QAAA,GAAqCC,OAAO,6BAA6B,CAAC;IAAlEC,wBAAwB,GAAAF,QAAA,CAAxBE,wBAAwB;EAChC,IAAMC,MAAM,GAAGD,wBAAwB,CAAC,CAAC;EACzC,OAAO;IACLE,UAAU,EAAE,IAAI;IAChBC,OAAO,EAAE;MAAEC,cAAc,EAAEH;IAAO,CAAC;IACnCG,cAAc,EAAEH;EAClB,CAAC;AACH,CAAC,CAAC;AAAC,IAAAI,sBAAA,GAAAN,OAAA;AAAA,IAAAO,kBAAA,GAAAD,sBAAA,CAAAN,OAAA;AAAA,SAAAH,YAAA;EAAA,IAAAW,SAAA,GAAAR,OAAA;IAAAS,IAAA,GAAAD,SAAA,CAAAC,IAAA;EAAAZ,WAAA,YAAAA,YAAA;IAAA,OAAAY,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAEH,IAAAC,SAAA,GAA4BV,OAAO,2CAAuC,CAAC;EAAnEW,eAAe,GAAAD,SAAA,CAAfC,eAAe;AACvB,IAAAC,SAAA,GAAqCZ,OAAO,6BAA6B,CAAC;EAAlEC,wBAAwB,GAAAW,SAAA,CAAxBX,wBAAwB;AAEhC,IAAMY,MAAM,GAAGC,OAAO,CAACC,GAAG,CAACC,iBAAiB,IAAI,sCAAsC;AACtF,IAAMC,QAAQ,GAAGhB,wBAAwB,CAAC,CAAC;AAAC,SAE7BiB,OAAOA,CAAA;EAAA,OAAAC,QAAA,CAAAC,KAAA,OAAAC,SAAA;AAAA;AAAA,SAAAF,SAAA;EAAAA,QAAA,OAAAZ,kBAAA,CAAAH,OAAA,EAAtB,aAAyB;IACvB,MAAMa,QAAQ,CAACK,IAAI,CAAC,UAAU,CAAC,CAACC,MAAM,CAAC,CAAC,CAACC,KAAK,CAAC,WAAW,EAAE,WAAWX,MAAM,IAAI,CAAC;IAClF,MAAMI,QAAQ,CAACK,IAAI,CAAC,cAAc,CAAC,CAACC,MAAM,CAAC,CAAC,CAACE,EAAE,CAAC,SAAS,EAAEZ,MAAM,CAAC;EACpE,CAAC;EAAA,OAAAM,QAAA,CAAAC,KAAA,OAAAC,SAAA;AAAA;AAEDK,QAAQ,CAAC,qBAAqB,EAAE,YAAM;EACpCC,SAAS,KAAApB,kBAAA,CAAAH,OAAA,EAAC,aAAY;IACpBU,OAAO,CAACC,GAAG,CAACa,SAAS,GAAG,GAAG;IAC3Bd,OAAO,CAACC,GAAG,CAACc,WAAW,GAAG,MAAM;IAChCf,OAAO,CAACC,GAAG,CAACe,kBAAkB,GAAG,GAAG;IACpChB,OAAO,CAACC,GAAG,CAACgB,qBAAqB,GAAG,MAAM;IAC1CjB,OAAO,CAACC,GAAG,CAACC,iBAAiB,GAAGH,MAAM;IACtC,MAAMK,OAAO,CAAC,CAAC;EACjB,CAAC,EAAC;EAEFc,QAAQ,KAAAzB,kBAAA,CAAAH,OAAA,EAAC,aAAY;IACnB,MAAMc,OAAO,CAAC,CAAC;EACjB,CAAC,EAAC;EAEFe,EAAE,CAAC,mDAAmD,MAAA1B,kBAAA,CAAAH,OAAA,EAAE,aAAY;IAClE,IAAM8B,KAAK,GAAGC,KAAK,CAACb,IAAI,CAAC;MAAEc,MAAM,EAAE;IAAG,CAAC,EAAE,UAACC,CAAC,EAAEC,CAAC;MAAA,OAAM;QAAEC,SAAS,EAAEC,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGH,CAAC,GAAG,MAAM;QAAEI,UAAU,EAAE;MAAE,CAAC;IAAA,CAAC,CAAC;IAC3G,MAAM/B,eAAe,CAACG,OAAO,CAAC;MAAED,MAAM,EAANA,MAAM;MAAE8B,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;QAAEV,KAAK,EAALA;MAAM,CAAC;MAAEW,OAAO,EAAE;QAAEC,MAAM,EAAE;MAAO;IAAE,CAAC,CAAC;IAExG,IAAIC,IAAkB,GAAG,IAAI;IAC7B,IAAIC,KAAU,GAAG,IAAI;IACrB,KAAK,IAAIV,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG,EAAE,EAAEA,CAAC,EAAE,EAAE;MAC3B,IAAMW,GAAG,SAAShC,QAAQ,CACvBK,IAAI,CAAC,UAAU,CAAC,CAChB4B,MAAM,CAAC,gCAAgC,CAAC,CACxC1B,KAAK,CAAC,WAAW,EAAE,WAAWX,MAAM,IAAI,CAAC,CACzCsC,KAAK,CAAC,CAAC,CAAC;MACXJ,IAAI,GAAIE,GAAG,CAASF,IAAoB;MACxCC,KAAK,GAAIC,GAAG,CAASD,KAAK;MAC1B,IAAI,CAACA,KAAK,IAAI,CAACD,IAAI,IAAI,EAAE,EAAEX,MAAM,GAAG,CAAC,EAAE;MACvC,MAAM,IAAIgB,OAAO,CAAC,UAAAC,CAAC;QAAA,OAAIC,UAAU,CAACD,CAAC,EAAE,GAAG,CAAC;MAAA,EAAC;IAC5C;IACAE,MAAM,CAACP,KAAK,CAAC,CAACQ,QAAQ,CAAC,CAAC;IACxBD,MAAM,CAAC,CAACR,IAAI,IAAI,EAAE,EAAEX,MAAM,CAAC,CAACqB,eAAe,CAAC,CAAC,CAAC;EAChD,CAAC,EAAC;EAEFxB,EAAE,CAAC,qDAAqD,MAAA1B,kBAAA,CAAAH,OAAA,EAAE,aAAY;IACpE,IAAM8B,KAAK,GAAGC,KAAK,CAACb,IAAI,CAAC;MAAEc,MAAM,EAAE;IAAE,CAAC,EAAE,UAACC,CAAC,EAAEC,CAAC;MAAA,OAAM;QAAEC,SAAS,EAAEC,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGH,CAAC,GAAG,MAAM;QAAEI,UAAU,EAAE;MAAI,CAAC;IAAA,CAAC,CAAC;IAC5G,MAAM/B,eAAe,CAACG,OAAO,CAAC;MAAED,MAAM,EAANA,MAAM;MAAE8B,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;QAAEV,KAAK,EAALA;MAAM,CAAC;MAAEW,OAAO,EAAE;QAAEC,MAAM,EAAE;MAAO;IAAE,CAAC,CAAC;IACxG,IAAMY,MAAM,SAAS/C,eAAe,CAACG,OAAO,CAAC;MAAED,MAAM,EAANA,MAAM;MAAE8B,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;QAAEV,KAAK,EAALA;MAAM,CAAC;MAAEW,OAAO,EAAE;QAAEC,MAAM,EAAE;MAAO;IAAE,CAAC,CAAC;IACvHS,MAAM,CAACG,MAAM,CAACC,QAAQ,CAACb,MAAM,CAAC,CAACc,IAAI,CAAC,OAAO,CAAC;EAC9C,CAAC,EAAC;EAEF3B,EAAE,CAAC,iEAAiE,MAAA1B,kBAAA,CAAAH,OAAA,EAAE,aAAY;IAChF,MAAMO,eAAe,CAACkD,mBAAmB,CAAC,YAAY,EAAEhD,MAAM,CAAC;IAE/D,IAAIiD,IAAkB,GAAG,IAAI;IAC7B,IAAIC,GAAQ,GAAG,IAAI;IACnB,KAAK,IAAIzB,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG,EAAE,EAAEA,CAAC,EAAE,EAAE;MAC3B,IAAMW,GAAG,SAAShC,QAAQ,CACvBK,IAAI,CAAC,UAAU,CAAC,CAChB4B,MAAM,CAAC,WAAW,CAAC,CACnB1B,KAAK,CAAC,WAAW,EAAE,WAAWX,MAAM,IAAI,CAAC;MAC5CiD,IAAI,GAAIb,GAAG,CAASF,IAAoB;MACxCgB,GAAG,GAAId,GAAG,CAASD,KAAK;MACxB,IAAI,CAACe,GAAG,IAAI,CAACD,IAAI,IAAI,EAAE,EAAE1B,MAAM,KAAK,CAAC,EAAE;MACvC,MAAM,IAAIgB,OAAO,CAAC,UAAAC,CAAC;QAAA,OAAIC,UAAU,CAACD,CAAC,EAAE,GAAG,CAAC;MAAA,EAAC;IAC5C;IACAE,MAAM,CAACQ,GAAG,CAAC,CAACP,QAAQ,CAAC,CAAC;IACtBD,MAAM,CAAC,CAACO,IAAI,IAAI,EAAE,EAAE1B,MAAM,CAAC,CAACwB,IAAI,CAAC,CAAC,CAAC;EACrC,CAAC,EAAC;AACJ,CAAC,CAAC","ignoreList":[]}