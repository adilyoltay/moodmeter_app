{"version":3,"names":["_getJestObj","mock","supabase","mockClient","_interopRequireDefault","require","_asyncToGenerator2","_require2","jest","callLog","qb","table","state","filters","api","select","fn","_len","arguments","length","args","Array","_key","push","op","upsert","_len2","_key2","insert","_len3","_key3","update","_len4","_key4","delete","_len5","_key5","eq","field","value","maybeSingle","default","data","error","single","ok","mockAuth","getUser","user","id","email","user_metadata","name","app_metadata","provider","updateUser","from","auth","getSvc","mod","console","log","Object","keys","createSupabaseServiceForTest","beforeEach","clearAllMocks","describe","test","userId","payload","profile","age","gender","locale","timezone","motivation","first_mood","score","tags","lifestyle","sleep_hours","exercise","social","reminders","enabled","time","days","feature_flags","a","b","consent","accepted","mockImplementation","_require","mapOnboardingPayloadToUserProfileRow","body","expect","user_id","toBe","motivations","toEqual","first_mood_score","first_mood_tags","reminder_enabled","reminder_time","onboarding_version","onboarding_completed_at"],"sources":["auth_onboarding_supabase.test.ts"],"sourcesContent":["// Lightweight Supabase client mock wired via module alias\ntype AnyFn = (...args: any[]) => any;\n\nconst callLog: any[] = [];\n\n// Chainable query builder mock\nfunction qb(table: string) {\n  const state: any = { table, filters: [] };\n  const api: any = {\n    select: jest.fn((...args: any[]) => { callLog.push({ op: 'select', table, args }); return api; }),\n    upsert: jest.fn((...args: any[]) => { callLog.push({ op: 'upsert', table, args }); return api; }),\n    insert: jest.fn((...args: any[]) => { callLog.push({ op: 'insert', table, args }); return api; }),\n    update: jest.fn((...args: any[]) => { callLog.push({ op: 'update', table, args }); return api; }),\n    delete: jest.fn((...args: any[]) => { callLog.push({ op: 'delete', table, args }); return api; }),\n    eq: jest.fn((field: string, value: any) => { state.filters.push({ field, value }); return api; }),\n    maybeSingle: jest.fn(async () => ({ data: null, error: null })),\n    single: jest.fn(async () => ({ data: { ok: true }, error: null })),\n  };\n  return api;\n}\n\nconst mockAuth = {\n  getUser: jest.fn(async () => ({\n    user: {\n      id: 'user-1',\n      email: 'new@user.test',\n      user_metadata: { name: 'New User' },\n      app_metadata: { provider: 'email' }\n    }\n  })),\n  updateUser: jest.fn(async () => ({ data: {}, error: null })),\n};\n\nconst mockClient = {\n  from: jest.fn((table: string) => qb(table)),\n  auth: mockAuth,\n};\n\njest.mock('@/lib/supabase', () => ({\n  supabase: mockClient,\n}));\n\n// Defer importing the service until after mocks are set up\nconst getSvc = () => {\n  const mod = require('../../services/supabase');\n  // Debug available exports if needed\n  // eslint-disable-next-line no-console\n  console.log('services/supabase exports:', Object.keys(mod));\n  const { createSupabaseServiceForTest } = mod;\n  // Inject our mock Supabase client to the service\n  return createSupabaseServiceForTest(mockClient as any);\n};\n\nbeforeEach(() => {\n  callLog.length = 0;\n  jest.clearAllMocks();\n});\n\ndescribe('Onboarding mapping â†’ user_profiles upsert body', () => {\n  test('maps onboarding payload correctly into user_profiles', async () => {\n    const userId = 'user-2';\n    const payload = {\n      profile: { age: 27, gender: 'male', locale: 'tr-TR', timezone: 'Europe/Istanbul' },\n      motivation: ['stress_reduction', 'mental_clarity'],\n      first_mood: { score: 6, tags: ['work', 'sleep'] }, // score should clamp to 5\n      lifestyle: { sleep_hours: 5, exercise: 'Regular', social: 'High' },\n      reminders: { enabled: true, time: '21:30', days: ['Mon','Wed'], timezone: 'Europe/Istanbul' },\n      feature_flags: { a: true, b: false },\n      consent: { accepted: true },\n    };\n\n    // fresh mock per test\n    (mockClient.from as AnyFn).mockImplementation((table: string) => qb(table));\n\n    // Instead of calling service (resolver differences), test exported mapper\n    const { mapOnboardingPayloadToUserProfileRow } = require('../../utils/onboardingMapper');\n    const body = mapOnboardingPayloadToUserProfileRow(userId, payload);\n\n    // Key field expectations\n    expect(body.user_id).toBe(userId);\n    expect(body.motivations).toEqual(['stress_reduction', 'mental_clarity']);\n    expect(body.first_mood_score).toBe(5); // clamped\n    expect(body.first_mood_tags).toEqual(['work','sleep']);\n    expect(body.reminder_enabled).toBe(true);\n    expect(body.reminder_time).toBe('21:30');\n    expect(body.feature_flags).toEqual({ a: true, b: false });\n    expect(body.onboarding_version).toBe(2);\n    expect(typeof body.onboarding_completed_at).toBe('string');\n  });\n});\n"],"mappings":"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","ignoreList":[]}