c54245db1ddb57d475dced074ab5ed0b
_getJestObj().mock("../../services/supabase", function () {
  var _require = require("./utils/supabaseTestClient"),
    createSupabaseTestClient = _require.createSupabaseTestClient;
  var client = createSupabaseTestClient();
  return {
    __esModule: true,
    default: {
      supabaseClient: client
    },
    supabaseClient: client
  };
});
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));
function _getJestObj() {
  var _require4 = require("@jest/globals"),
    jest = _require4.jest;
  _getJestObj = function _getJestObj() {
    return jest;
  };
  return jest;
}
var _require2 = require("../../features/ai/core/UnifiedAIPipeline"),
  unifiedPipeline = _require2.unifiedPipeline;
var _require3 = require("./utils/supabaseTestClient"),
  createSupabaseTestClient = _require3.createSupabaseTestClient;
var userId = process.env.TEST_SEED_USER_ID || '00000000-0000-0000-0000-000000000001';
var supabase = createSupabaseTestClient();
function cleanup() {
  return _cleanup.apply(this, arguments);
}
function _cleanup() {
  _cleanup = (0, _asyncToGenerator2.default)(function* () {
    yield supabase.from('ai_telemetry').delete().eq('user_id', userId);
  });
  return _cleanup.apply(this, arguments);
}
describe('Live Telemetry Supabase', function () {
  jest.setTimeout(20000);
  beforeAll((0, _asyncToGenerator2.default)(function* () {
    process.env.TEST_MODE = '1';
    process.env.TEST_TTL_MS = '5000';
    process.env.TEST_PIPELINE_STUB = '0';
    process.env.EXPO_PUBLIC_ENABLE_AI = 'true';
    process.env.TEST_SEED_USER_ID = userId;
    yield cleanup();
  }));
  afterAll((0, _asyncToGenerator2.default)(function* () {
    yield cleanup();
  }));
  it('[QRlive:telemetry:started] and [QRlive:telemetry:completed] are recorded', (0, _asyncToGenerator2.default)(function* () {
    var moods = Array.from({
      length: 6
    }, function (_, i) {
      return {
        timestamp: Date.now() - i * 900e3,
        mood_score: 6
      };
    });
    yield unifiedPipeline.process({
      userId: userId,
      type: 'data',
      content: {
        moods: moods
      },
      context: {
        source: 'mood'
      }
    });
    var data = null;
    var error = null;
    for (var i = 0; i < 10; i++) {
      var res = yield supabase.from('ai_telemetry').select('event_type').eq('user_id', userId);
      data = res.data;
      error = res.error;
      if (!error && (data || []).length > 0) break;
      yield new Promise(function (r) {
        return setTimeout(r, 100);
      });
    }
    expect(error).toBeNull();
    var events = (data || []).map(function (r) {
      return String(r.event_type);
    });
    expect(events.some(function (e) {
      return e.includes('unified_pipeline_started');
    })).toBe(true);
    expect(events.some(function (e) {
      return e.includes('unified_pipeline_completed');
    })).toBe(true);
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZ2V0SmVzdE9iaiIsIm1vY2siLCJfcmVxdWlyZSIsInJlcXVpcmUiLCJjcmVhdGVTdXBhYmFzZVRlc3RDbGllbnQiLCJjbGllbnQiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsInN1cGFiYXNlQ2xpZW50IiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsIl9hc3luY1RvR2VuZXJhdG9yMiIsIl9yZXF1aXJlNCIsImplc3QiLCJfcmVxdWlyZTIiLCJ1bmlmaWVkUGlwZWxpbmUiLCJfcmVxdWlyZTMiLCJ1c2VySWQiLCJwcm9jZXNzIiwiZW52IiwiVEVTVF9TRUVEX1VTRVJfSUQiLCJzdXBhYmFzZSIsImNsZWFudXAiLCJfY2xlYW51cCIsImFwcGx5IiwiYXJndW1lbnRzIiwiZnJvbSIsImRlbGV0ZSIsImVxIiwiZGVzY3JpYmUiLCJzZXRUaW1lb3V0IiwiYmVmb3JlQWxsIiwiVEVTVF9NT0RFIiwiVEVTVF9UVExfTVMiLCJURVNUX1BJUEVMSU5FX1NUVUIiLCJFWFBPX1BVQkxJQ19FTkFCTEVfQUkiLCJhZnRlckFsbCIsIml0IiwibW9vZHMiLCJBcnJheSIsImxlbmd0aCIsIl8iLCJpIiwidGltZXN0YW1wIiwiRGF0ZSIsIm5vdyIsIm1vb2Rfc2NvcmUiLCJ0eXBlIiwiY29udGVudCIsImNvbnRleHQiLCJzb3VyY2UiLCJkYXRhIiwiZXJyb3IiLCJyZXMiLCJzZWxlY3QiLCJQcm9taXNlIiwiciIsImV4cGVjdCIsInRvQmVOdWxsIiwiZXZlbnRzIiwibWFwIiwiU3RyaW5nIiwiZXZlbnRfdHlwZSIsInNvbWUiLCJlIiwiaW5jbHVkZXMiLCJ0b0JlIl0sInNvdXJjZXMiOlsiTGl2ZVRlbGVtZXRyeVN1cGFiYXNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBMaXZlIFN1cGFiYXNlIFRlc3RzIOKAlCBUZWxlbWV0cnkgKFFSbGl2ZSlcbiAqIFRhZ3M6IFtRUmxpdmU6dGVsZW1ldHJ5OnN0YXJ0ZWRdIFtRUmxpdmU6dGVsZW1ldHJ5OmNvbXBsZXRlZF1cbiAqL1xuamVzdC5tb2NrKCdAL3NlcnZpY2VzL3N1cGFiYXNlJywgKCkgPT4ge1xuICBjb25zdCB7IGNyZWF0ZVN1cGFiYXNlVGVzdENsaWVudCB9ID0gcmVxdWlyZSgnLi91dGlscy9zdXBhYmFzZVRlc3RDbGllbnQnKTtcbiAgY29uc3QgY2xpZW50ID0gY3JlYXRlU3VwYWJhc2VUZXN0Q2xpZW50KCk7XG4gIHJldHVybiB7XG4gICAgX19lc01vZHVsZTogdHJ1ZSxcbiAgICBkZWZhdWx0OiB7IHN1cGFiYXNlQ2xpZW50OiBjbGllbnQgfSxcbiAgICBzdXBhYmFzZUNsaWVudDogY2xpZW50LFxuICB9O1xufSk7XG5cbmNvbnN0IHsgdW5pZmllZFBpcGVsaW5lIH0gPSByZXF1aXJlKCdAL2ZlYXR1cmVzL2FpL2NvcmUvVW5pZmllZEFJUGlwZWxpbmUnKTtcbmNvbnN0IHsgY3JlYXRlU3VwYWJhc2VUZXN0Q2xpZW50IH0gPSByZXF1aXJlKCcuL3V0aWxzL3N1cGFiYXNlVGVzdENsaWVudCcpO1xuXG5jb25zdCB1c2VySWQgPSBwcm9jZXNzLmVudi5URVNUX1NFRURfVVNFUl9JRCB8fCAnMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAxJztcbmNvbnN0IHN1cGFiYXNlID0gY3JlYXRlU3VwYWJhc2VUZXN0Q2xpZW50KCk7XG5cbmFzeW5jIGZ1bmN0aW9uIGNsZWFudXAoKSB7XG4gIGF3YWl0IHN1cGFiYXNlLmZyb20oJ2FpX3RlbGVtZXRyeScpLmRlbGV0ZSgpLmVxKCd1c2VyX2lkJywgdXNlcklkKTtcbn1cblxuZGVzY3JpYmUoJ0xpdmUgVGVsZW1ldHJ5IFN1cGFiYXNlJywgKCkgPT4ge1xuICBqZXN0LnNldFRpbWVvdXQoMjAwMDApO1xuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIHByb2Nlc3MuZW52LlRFU1RfTU9ERSA9ICcxJztcbiAgICBwcm9jZXNzLmVudi5URVNUX1RUTF9NUyA9ICc1MDAwJztcbiAgICBwcm9jZXNzLmVudi5URVNUX1BJUEVMSU5FX1NUVUIgPSAnMCc7XG4gICAgcHJvY2Vzcy5lbnYuRVhQT19QVUJMSUNfRU5BQkxFX0FJID0gJ3RydWUnO1xuICAgIHByb2Nlc3MuZW52LlRFU1RfU0VFRF9VU0VSX0lEID0gdXNlcklkO1xuICAgIGF3YWl0IGNsZWFudXAoKTtcbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGNsZWFudXAoKTtcbiAgfSk7XG5cbiAgaXQoJ1tRUmxpdmU6dGVsZW1ldHJ5OnN0YXJ0ZWRdIGFuZCBbUVJsaXZlOnRlbGVtZXRyeTpjb21wbGV0ZWRdIGFyZSByZWNvcmRlZCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb29kcyA9IEFycmF5LmZyb20oeyBsZW5ndGg6IDYgfSwgKF8sIGkpID0+ICh7IHRpbWVzdGFtcDogRGF0ZS5ub3coKSAtIGkgKiA5MDBlMywgbW9vZF9zY29yZTogNiB9KSk7XG4gICAgYXdhaXQgdW5pZmllZFBpcGVsaW5lLnByb2Nlc3MoeyB1c2VySWQsIHR5cGU6ICdkYXRhJywgY29udGVudDogeyBtb29kcyB9LCBjb250ZXh0OiB7IHNvdXJjZTogJ21vb2QnIH0gfSk7XG4gICAgLy8gUG9sbCB1bnRpbCB0ZWxlbWV0cnkgcm93cyBhcHBlYXJcbiAgICBsZXQgZGF0YTogYW55W10gfCBudWxsID0gbnVsbDtcbiAgICBsZXQgZXJyb3I6IGFueSA9IG51bGw7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDsgaSsrKSB7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgICAuZnJvbSgnYWlfdGVsZW1ldHJ5JylcbiAgICAgICAgLnNlbGVjdCgnZXZlbnRfdHlwZScpXG4gICAgICAgIC5lcSgndXNlcl9pZCcsIHVzZXJJZCk7XG4gICAgICBkYXRhID0gKHJlcyBhcyBhbnkpLmRhdGEgYXMgYW55W10gfCBudWxsO1xuICAgICAgZXJyb3IgPSAocmVzIGFzIGFueSkuZXJyb3I7XG4gICAgICBpZiAoIWVycm9yICYmIChkYXRhIHx8IFtdKS5sZW5ndGggPiAwKSBicmVhaztcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCAxMDApKTtcbiAgICB9XG4gICAgZXhwZWN0KGVycm9yKS50b0JlTnVsbCgpO1xuICAgIGNvbnN0IGV2ZW50cyA9IChkYXRhIHx8IFtdKS5tYXAociA9PiBTdHJpbmcoKHIgYXMgYW55KS5ldmVudF90eXBlKSk7XG4gICAgZXhwZWN0KGV2ZW50cy5zb21lKGUgPT4gZS5pbmNsdWRlcygndW5pZmllZF9waXBlbGluZV9zdGFydGVkJykpKS50b0JlKHRydWUpO1xuICAgIGV4cGVjdChldmVudHMuc29tZShlID0+IGUuaW5jbHVkZXMoJ3VuaWZpZWRfcGlwZWxpbmVfY29tcGxldGVkJykpKS50b0JlKHRydWUpO1xuICB9KTtcbn0pO1xuXG5cbiJdLCJtYXBwaW5ncyI6IkFBSUFBLFdBQUEsR0FBS0MsSUFBSSw0QkFBd0IsWUFBTTtFQUNyQyxJQUFBQyxRQUFBLEdBQXFDQyxPQUFPLDZCQUE2QixDQUFDO0lBQWxFQyx3QkFBd0IsR0FBQUYsUUFBQSxDQUF4QkUsd0JBQXdCO0VBQ2hDLElBQU1DLE1BQU0sR0FBR0Qsd0JBQXdCLENBQUMsQ0FBQztFQUN6QyxPQUFPO0lBQ0xFLFVBQVUsRUFBRSxJQUFJO0lBQ2hCQyxPQUFPLEVBQUU7TUFBRUMsY0FBYyxFQUFFSDtJQUFPLENBQUM7SUFDbkNHLGNBQWMsRUFBRUg7RUFDbEIsQ0FBQztBQUNILENBQUMsQ0FBQztBQUFDLElBQUFJLHNCQUFBLEdBQUFOLE9BQUE7QUFBQSxJQUFBTyxrQkFBQSxHQUFBRCxzQkFBQSxDQUFBTixPQUFBO0FBQUEsU0FBQUgsWUFBQTtFQUFBLElBQUFXLFNBQUEsR0FBQVIsT0FBQTtJQUFBUyxJQUFBLEdBQUFELFNBQUEsQ0FBQUMsSUFBQTtFQUFBWixXQUFBLFlBQUFBLFlBQUE7SUFBQSxPQUFBWSxJQUFBO0VBQUE7RUFBQSxPQUFBQSxJQUFBO0FBQUE7QUFFSCxJQUFBQyxTQUFBLEdBQTRCVixPQUFPLDJDQUF1QyxDQUFD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