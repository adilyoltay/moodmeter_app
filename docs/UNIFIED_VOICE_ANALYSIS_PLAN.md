# üéØ Merkezi Ses Analizi Sistemi - Geli≈ütirme Planƒ±

## üìã √ñzet
T√ºm ses giri≈ülerini Today sayfasƒ±ndan alƒ±p, Gemini API ile analiz ederek otomatik olarak ilgili sayfaya (CBT/OCD/ERP/Mood) y√∂nlendiren merkezi bir sistem.

## üèóÔ∏è Mimari Tasarƒ±m

```mermaid
graph TD
    A[Today Sayfasƒ± - Ses Giri≈üi] --> B[Unified Voice Analysis Service]
    B --> C[Gemini API]
    C --> D{Tip Tespiti}
    D -->|CBT| E[CBT Sayfasƒ±]
    D -->|OCD| F[OCD Tracking]
    D -->|ERP| G[ERP Sayfasƒ±]
    D -->|MOOD| H[Today - Mood Kaydƒ±]
    D -->|BREATHWORK| I[Nefes Egzersizi]
```

## üìù Uygulama Adƒ±mlarƒ±

### Faz 1: Merkezi Analiz Servisi (Sprint 1 - 3 g√ºn)

#### 1.1 Gemini API Entegrasyonu
**Dosya:** `features/ai/services/unifiedVoiceAnalysis.ts`

```typescript
import { externalAIService } from './externalAIService';

export interface VoiceAnalysisRequest {
  text: string;
  duration?: number;
  language: 'tr' | 'en';
  userId: string;
}

export interface VoiceAnalysisResponse {
  type: 'MOOD' | 'CBT' | 'OCD' | 'ERP' | 'BREATHWORK';
  confidence: number;
  reasoning: string;
  extractedData: {
    // Mood
    moodScore?: number;
    energyLevel?: number;
    anxietyLevel?: number;
    
    // CBT
    cognitiveDistortions?: string[];
    thoughtPattern?: string;
    
    // OCD
    compulsionType?: string;
    resistanceLevel?: number;
    trigger?: string;
    frequency?: number;
    
    // ERP
    exposureCategory?: string;
    anxietyBefore?: number;
    targetBehavior?: string;
  };
  suggestedAction: {
    page: string;
    params: Record<string, any>;
    message: string;
  };
}

class UnifiedVoiceAnalysisService {
  private static instance: UnifiedVoiceAnalysisService;
  
  async analyzeWithGemini(request: VoiceAnalysisRequest): Promise<VoiceAnalysisResponse> {
    const prompt = this.buildAnalysisPrompt(request);
    
    const response = await externalAIService.getAIResponse(
      [{ 
        content: prompt, 
        role: 'user',
        timestamp: new Date().toISOString(),
        id: `analysis_${Date.now()}`
      }],
      {
        conversationId: `voice_analysis_${Date.now()}`,
        userId: request.userId,
        sessionStartTime: new Date().toISOString(),
        messages: [],
        currentPhase: 'analysis'
      },
      {
        temperature: 0.3, // D√º≈ü√ºk temperature, tutarlƒ± analiz i√ßin
        maxTokens: 500,
        systemPrompt: this.getSystemPrompt()
      }
    );
    
    return this.parseGeminiResponse(response);
  }
  
  private buildAnalysisPrompt(request: VoiceAnalysisRequest): string {
    return `
    Kullanƒ±cƒ±nƒ±n ses kaydƒ± metni: "${request.text}"
    Kayƒ±t s√ºresi: ${request.duration ? Math.round(request.duration / 1000) : 'bilinmiyor'} saniye
    Dil: ${request.language === 'tr' ? 'T√ºrk√ße' : 'ƒ∞ngilizce'}
    
    Bu metni analiz et ve ≈üu kategorilerden birine sƒ±nƒ±flandƒ±r:
    
    1. MOOD - Genel duygu durumu ifadesi
       √ñrnekler: "Bug√ºn kendimi iyi hissediyorum", "√áok yorgunum"
    
    2. CBT - Bili≈üsel √ßarpƒ±tma i√ßeren d√º≈ü√ºnceler
       √ñrnekler: "Kesin ba≈üƒ±ma k√∂t√º bir ≈üey gelecek", "Herkes benden nefret ediyor"
       √áarpƒ±tma tipleri: Felaketle≈ütirme, Ya hep ya hi√ß, A≈üƒ±rƒ± genelleme, Zihin okuma, Falcƒ±lƒ±k
    
    3. OCD - Obsesif kompulsif davranƒ±≈ü kayƒ±tlarƒ±
       √ñrnekler: "Ellerimi 5 kez yƒ±kadƒ±m", "Kapƒ±yƒ± 3 kez kontrol ettim"
       Kategoriler: Temizlik, Kontrol, Sayma, D√ºzen/Simetri, Zihinsel
    
    4. ERP - Maruz bƒ±rakma egzersizi niyeti
       √ñrnekler: "Bug√ºn kapƒ±yƒ± kontrol etmemeye √ßalƒ±≈üacaƒüƒ±m", "Kirli y√ºzeye dokunma egzersizi yapacaƒüƒ±m"
    
    5. BREATHWORK - Nefes/rahatlama ihtiyacƒ±
       √ñrnekler: "Nefes alamƒ±yorum", "Panik atak ge√ßiriyorum", "Sakinle≈ümem lazƒ±m"
    
    JSON formatƒ±nda yanƒ±t ver:
    {
      "type": "MOOD|CBT|OCD|ERP|BREATHWORK",
      "confidence": 0.0-1.0,
      "reasoning": "Neden bu kategori se√ßildi",
      "extractedData": {
        // Tip'e g√∂re ilgili veriler
      },
      "suggestedAction": {
        "page": "Y√∂nlendirilecek sayfa",
        "message": "Kullanƒ±cƒ±ya g√∂sterilecek mesaj"
      }
    }
    `;
  }
  
  private getSystemPrompt(): string {
    return `Sen, OKB (Obsesif Kompulsif Bozukluk) tedavisinde uzmanla≈ümƒ±≈ü bir AI asistanƒ±sƒ±n.
    G√∂revin, kullanƒ±cƒ±larƒ±n ses kayƒ±tlarƒ±nƒ± analiz edip doƒüru terap√∂tik m√ºdahaleye y√∂nlendirmek.
    
    Analiz kriterlerin:
    - Bili≈üsel √ßarpƒ±tmalarƒ± tespit et (CBT)
    - Kompulsif davranƒ±≈ülarƒ± tanƒ±mla (OCD)
    - ERP egzersiz niyetlerini anla
    - Panik/anksiyete durumlarƒ±nƒ± fark et (Breathwork)
    - Genel mood ifadelerini ayƒ±rt et
    
    Her zaman empatik, yargƒ±lamayan ve destekleyici ol.
    T√ºrk√ße konu≈ü ve k√ºlt√ºrel baƒülama duyarlƒ± ol.`;
  }
}

export const unifiedVoiceAnalysis = UnifiedVoiceAnalysisService.getInstance();
```

#### 1.2 Today Sayfasƒ± Entegrasyonu
**Dosya:** `app/(tabs)/index.tsx`

```typescript
import { unifiedVoiceAnalysis } from '@/features/ai/services/unifiedVoiceAnalysis';

const handleVoiceTranscription = async (res: TranscriptionResult) => {
  if (!user?.id) return;
  
  setAnalyzing(true);
  try {
    // Gemini ile analiz
    const analysis = await unifiedVoiceAnalysis.analyzeWithGemini({
      text: res.text,
      duration: res.duration,
      language: res.language || 'tr',
      userId: user.id
    });
    
    // Tip'e g√∂re y√∂nlendirme
    switch (analysis.type) {
      case 'MOOD':
        await saveMoodEntry(analysis.extractedData);
        setToastMessage(analysis.suggestedAction.message);
        break;
        
      case 'CBT':
        router.push({
          pathname: '/(tabs)/cbt',
          params: {
            autoOpen: true,
            thoughtText: res.text,
            distortions: JSON.stringify(analysis.extractedData.cognitiveDistortions)
          }
        });
        break;
        
      case 'OCD':
        router.push({
          pathname: '/(tabs)/tracking',
          params: {
            autoOpenOCD: true,
            prefillType: analysis.extractedData.compulsionType,
            prefillResistance: analysis.extractedData.resistanceLevel,
            prefillNotes: res.text
          }
        });
        break;
        
      case 'ERP':
        router.push({
          pathname: '/(tabs)/erp',
          params: {
            autoSelectCategory: analysis.extractedData.exposureCategory,
            prefillAnxiety: analysis.extractedData.anxietyBefore
          }
        });
        break;
        
      case 'BREATHWORK':
        router.push({
          pathname: '/(tabs)/breathwork',
          params: {
            autoStart: true,
            technique: analysis.extractedData.anxietyLevel > 7 ? '4-7-8' : 'box'
          }
        });
        break;
    }
    
    // Telemetry
    await trackAIInteraction(AIEventType.VOICE_ANALYSIS_COMPLETED, {
      type: analysis.type,
      confidence: analysis.confidence,
      userId: user.id
    });
    
  } catch (error) {
    console.error('Voice analysis failed:', error);
    setToastMessage('Ses analizi ba≈üarƒ±sƒ±z, l√ºtfen tekrar deneyin');
  } finally {
    setAnalyzing(false);
  }
};
```

### Faz 2: CBT Sayfasƒ± Yeniden Tasarƒ±mƒ± (Sprint 2 - 2 g√ºn)

#### 2.1 CBT Sayfasƒ± (FAB Butonlu)
**Dosya:** `app/(tabs)/cbt.tsx`

```typescript
import React, { useState, useEffect } from 'react';
import { View, Text, StyleSheet, ScrollView, RefreshControl } from 'react-native';
import ScreenLayout from '@/components/layout/ScreenLayout';
import FAB from '@/components/ui/FAB';
import { useLocalSearchParams } from 'expo-router';
import CBTFormSheet from '@/components/forms/CBTFormSheet';
import CBTRecordCard from '@/components/cbt/CBTRecordCard';

export default function CBTScreen() {
  const params = useLocalSearchParams();
  const [showForm, setShowForm] = useState(false);
  const [records, setRecords] = useState<CBTRecord[]>([]);
  const [refreshing, setRefreshing] = useState(false);
  
  // Auto-open if triggered from voice
  useEffect(() => {
    if (params.autoOpen === 'true') {
      setShowForm(true);
    }
  }, [params.autoOpen]);
  
  const loadRecords = async () => {
    // Load from AsyncStorage + Supabase
    const localRecords = await loadLocalCBTRecords();
    const cloudRecords = await loadCloudCBTRecords();
    setRecords(mergeRecords(localRecords, cloudRecords));
  };
  
  useEffect(() => {
    loadRecords();
  }, []);
  
  return (
    <ScreenLayout>
      <View style={styles.header}>
        <Text style={styles.title}>D√º≈ü√ºnce Kayƒ±tlarƒ±</Text>
        <Text style={styles.subtitle}>Bili≈üsel √ßarpƒ±tmalarƒ±nƒ± ke≈üfet ve yeniden √ßer√ßevele</Text>
      </View>
      
      <ScrollView 
        style={styles.container}
        refreshControl={
          <RefreshControl refreshing={refreshing} onRefresh={loadRecords} />
        }
      >
        {records.length === 0 ? (
          <View style={styles.emptyState}>
            <Text style={styles.emptyText}>Hen√ºz d√º≈ü√ºnce kaydƒ±n yok</Text>
            <Text style={styles.emptySubtext}>
              + butonu ile ilk kaydƒ±nƒ± olu≈ütur veya ana sayfadan sesli giri≈ü yap
            </Text>
          </View>
        ) : (
          records.map(record => (
            <CBTRecordCard 
              key={record.id}
              record={record}
              onPress={() => openRecordDetail(record)}
            />
          ))
        )}
      </ScrollView>
      
      <FAB 
        icon="plus" 
        onPress={() => setShowForm(true)}
        position="fixed"
      />
      
      <CBTFormSheet
        visible={showForm}
        onClose={() => setShowForm(false)}
        prefillData={{
          thought: params.thoughtText,
          distortions: params.distortions ? JSON.parse(params.distortions) : []
        }}
        onSave={async (data) => {
          await saveCBTRecord(data);
          await loadRecords();
          setShowForm(false);
        }}
      />
    </ScreenLayout>
  );
}
```

### Faz 3: Diƒüer Sayfalardan Ses Check-in Kaldƒ±rma (Sprint 3 - 1 g√ºn)

#### 3.1 OCD Tracking Sayfasƒ±
- `VoiceMoodCheckin` component'ini kaldƒ±r
- Sadece FAB butonu ile manuel giri≈ü bƒ±rak

#### 3.2 ERP Sayfasƒ±  
- Ses check-in b√∂l√ºm√ºn√º kaldƒ±r
- Otomatik y√∂nlendirme parametrelerini ekle

### Faz 4: Test ve ƒ∞yile≈ütirme (Sprint 4 - 2 g√ºn)

#### 4.1 Test Senaryolarƒ±
```typescript
const testCases = [
  {
    input: "Kesin ba≈üƒ±ma k√∂t√º bir ≈üey gelecek",
    expectedType: "CBT",
    expectedDistortion: "Felaketle≈ütirme"
  },
  {
    input: "Ellerimi 5 kez yƒ±kadƒ±m ama hala kirli hissediyorum",
    expectedType: "OCD",
    expectedCategory: "cleaning"
  },
  {
    input: "Bug√ºn kapƒ±yƒ± kontrol etmeme egzersizi yapacaƒüƒ±m",
    expectedType: "ERP",
    expectedCategory: "checking"
  },
  {
    input: "Nefes alamƒ±yorum panik oluyorum",
    expectedType: "BREATHWORK"
  },
  {
    input: "Bug√ºn kendimi iyi hissediyorum",
    expectedType: "MOOD",
    expectedScore: 7
  }
];
```

## üìä Ba≈üarƒ± Metrikleri

1. **Doƒüru Sƒ±nƒ±flandƒ±rma Oranƒ±**: %85+ doƒüruluk
2. **Y√∂nlendirme S√ºresi**: < 3 saniye
3. **Kullanƒ±cƒ± Memnuniyeti**: 4.5+ yƒ±ldƒ±z
4. **G√ºnl√ºk Kullanƒ±m**: %40 artƒ±≈ü
5. **Form Tamamlama Oranƒ±**: %70+

## üöÄ Deployment Planƒ±

### Hafta 1
- [ ] Gemini API entegrasyonu
- [ ] UnifiedVoiceAnalysis servisi
- [ ] Today sayfasƒ± g√ºncelleme

### Hafta 2  
- [ ] CBT sayfasƒ± yeniden tasarƒ±m
- [ ] OCD/ERP sayfalarƒ±ndan ses kaldƒ±rma
- [ ] Test senaryolarƒ±

### Hafta 3
- [ ] Beta test (10 kullanƒ±cƒ±)
- [ ] Bug fix ve iyile≈ütirmeler
- [ ] Production deployment

## üîí G√ºvenlik ve Gizlilik

- Ses metinleri Gemini'ye g√∂nderilmeden √∂nce PII sanitizasyonu
- Analiz sonu√ßlarƒ± lokal cache'leme
- GDPR uyumlu veri saklama
- Kullanƒ±cƒ± onayƒ± ile cloud sync

## üì± UI/UX ƒ∞lkeleri

### Master Prompt Uyumu
- **Sakinlik**: Yumu≈üak animasyonlar, pastel renkler
- **G√º√ß Kullanƒ±cƒ±da**: Her zaman manuel giri≈ü se√ßeneƒüi
- **Zahmetsizlik**: Tek yerden t√ºm giri≈üler

### Tasarƒ±m Tutarlƒ±lƒ±ƒüƒ±
- T√ºm sayfalar FAB butonlu
- Bottom sheet formlar
- Consistent card designs
- Haptic feedback

## üîÑ Rollback Planƒ±

Eƒüer sistem ba≈üarƒ±sƒ±z olursa:
1. Feature flag ile devre dƒ±≈üƒ± bƒ±rak
2. Eski individual ses giri≈ülerine d√∂n
3. Kullanƒ±cƒ± verilerini koru
4. Hotfix deploy et

## üìà Gelecek ƒ∞yile≈ütirmeler

### V2.0 (Q2 2025)
- Multi-modal analiz (ses tonu + metin)
- Contextual √∂neriler
- Trend analizi
- Predictive interventions

### V3.0 (Q3 2025)
- Real-time coaching
- Group therapy support
- Therapist dashboard
- Advanced analytics

---

**Dok√ºman Versiyonu:** 1.0  
**Olu≈üturma Tarihi:** 2025-01-19  
**Son G√ºncelleme:** 2025-01-19  
**Sahip:** AI & Product Team  
**Durum:** üü¢ Onaylandƒ± - Geli≈ütirmeye Hazƒ±r
